<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 1. Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🌿</text></svg>">
    <!-- 2. Dynamic Title (set by JS) -->
    <title>Green Nanny Dashboard</title>

    <!-- Bootstrap 5.1+ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <!-- AdminLTE 3.1+ (Primarily for structure, custom styles override most) -->
    <link href="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/css/adminlte.min.css" rel="stylesheet">
    <!-- Font Awesome 5.15+ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet" />

    <!-- Estilos personalizados embebidos -->
    <style>
        /* --- Base Theme & Variables --- */
        :root {
            /* Core Colors */
            --gn-bg: #1e2125; /* Slightly adjusted dark */
            --gn-text: #e9ecef; /* Lighter main text */
            --gn-text-muted: #adb5bd;
            --gn-card-bg: #2a2e33; /* Slightly lighter card */
            --gn-border-color: #40454a; /* Defined border */
            --gn-input-bg: #3a3f44;
            --gn-input-border: #555a5f;
            --gn-navbar-bg: #16191c; /* Darker navbar */

            /* Accent Colors */
            --gn-primary: #0d6efd;
            --gn-success: #1faa5f; /* Vibrant Green */
            --gn-info: #0dcaf0;
            --gn-warning: #ffc107;
            --gn-danger: #dc3545;
            --gn-light: #f8f9fa;
            --gn-secondary: #6c757d;

            /* Chart Colors */
             --gn-chart-temp: rgba(255, 99, 132, 1); /* Red */
             --gn-chart-humid: rgba(54, 162, 235, 1); /* Blue */
             --gn-chart-pump: rgba(255, 206, 86, 0.9); /* Yellow, slightly less opaque */
             --gn-chart-grid: rgba(255, 255, 255, 0.08); /* Fainter grid */
             --gn-chart-text: var(--gn-text-muted);
             --gn-chart-tooltip-bg: rgba(0, 0, 0, 0.85);

            /* UI Elements */
            --gn-border-radius: 0.35rem;
            --gn-border-radius-sm: 0.25rem;
            --gn-box-shadow: 0 2px 5px rgba(0,0,0,0.25);
            --gn-box-shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
            --gn-box-shadow-inset: inset 0 1px 3px rgba(0,0,0,0.3);
            --gn-focus-ring-color: rgba(var(--bs-primary-rgb), .4);
            --gn-focus-outline-color: var(--gn-primary);

            /* Spacing */
            --gn-spacing-xs: 0.25rem;
            --gn-spacing-sm: 0.5rem;
            --gn-spacing-md: 1rem;
            --gn-spacing-lg: 1.5rem;
            --gn-spacing-xl: 2rem;

            /* Font */
            --gn-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --gn-base-font-size: 0.95rem;
            --gn-line-height: 1.6;
            --gn-heading-font-weight: 300;
            --gn-body-font-weight: 400;
            --gn-label-font-weight: 500;
            --gn-widget-value-font-weight: 600;
            --gn-widget-title-font-size: 1.05rem;

            /* Transitions */
            --gn-transition-fast: 0.2s ease-out;
            --gn-transition-std: 0.3s ease-out;
        }

        html {
             scroll-behavior: smooth; /* 100 */
        }

        body {
            background-color: var(--gn-bg);
            color: var(--gn-text);
            font-family: var(--gn-font-family);
            font-size: var(--gn-base-font-size);
            line-height: var(--gn-line-height);
            font-weight: var(--gn-body-font-weight);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Subtle background pattern (1) */
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23343a40' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- Accessibility --- */
        /* Improved focus state (6, 87) */
        *:focus-visible {
            outline: 2px solid var(--gn-focus-outline-color);
            outline-offset: 2px;
            box-shadow: 0 0 0 3px var(--gn-focus-ring-color) !important; /* Ensure visibility */
        }
        .visually-hidden-focusable:focus { /* Ensure skip link is highly visible */
             background-color: var(--gn-primary); color: white; padding: var(--gn-spacing-sm);
             position: fixed; top: 5px; left: 5px; z-index: 1100; border-radius: var(--gn-border-radius-sm);
        }

        /* Reduce Motion (89, 90) */
        @media (prefers-reduced-motion: reduce) {
          *, *::before, *::after {
            animation-duration: 0.01ms !important;
            animation-iteration-count: 1 !important;
            transition-duration: 0.01ms !important;
            scroll-behavior: auto !important;
          }
          .loader { animation: none; border-width: 3px; }
          #globalLoader { animation: none; opacity: 0.8; }
          .pulsing { animation: none; box-shadow: 0 0 5px rgba(var(--bs-success-rgb), 0.5) !important; }
          .updated { animation: none; }
        }

        /* --- Layout & Structure --- */
        .content-wrapper {
             background-color: transparent; /* Inherit body background */
             padding: var(--gn-spacing-lg); /* Consistent padding (3) */
             min-height: calc(100vh - 58px - 51px); /* Adjusted for potential navbar/footer height */
        }
         .content-header h1 {
             margin-bottom: var(--gn-spacing-lg); /* (3) */
             font-weight: var(--gn-heading-font-weight); /* (8) */
             letter-spacing: 0.5px; /* (8) */
         }
         hr {
             border-top: 1px solid var(--gn-border-color);
             margin: var(--gn-spacing-xl) 0; /* More spacing */
             opacity: 0.3; /* Softer */
         }

        /* --- Navbar --- */
        .navbar {
            background-color: var(--gn-navbar-bg) !important;
            box-shadow: var(--gn-box-shadow); /* (13) */
            padding: var(--gn-spacing-xs) var(--gn-spacing-md); /* (15) */
        }
        .navbar-brand { font-weight: 500; /* (11) */ }
        .navbar-brand svg { margin-right: 10px; }
        .nav-link { transition: color var(--gn-transition-fast); padding: var(--gn-spacing-sm) var(--gn-spacing-md); }
        .nav-link.active {
             font-weight: 600;
             color: var(--gn-primary) !important;
             border-bottom: 2px solid var(--gn-primary); /* (12) */
        }
        .navbar-dark .navbar-toggler { border-color: rgba(255,255,255,.2); }
        .navbar-text { font-size: 0.85rem; color: var(--gn-text-muted); } /* (14) */

        /* --- Widgets (General & Small Boxes) --- */
        .widget-dark, .small-box {
            background-color: var(--gn-card-bg);
            color: var(--gn-text);
            border: 1px solid var(--gn-border-color); /* (4) */
            border-radius: var(--gn-border-radius); /* (10) */
            padding: var(--gn-spacing-md); /* (3) */
            margin-bottom: var(--gn-spacing-md); /* (3) */
            box-shadow: var(--gn-box-shadow-sm); /* (20) */
            transition: transform var(--gn-transition-fast), box-shadow var(--gn-transition-fast); /* (5) */
            height: 100%; /* Ensure equal height in row */
            display: flex;
            flex-direction: column;
            position: relative; /* For icon positioning */
        }
        .widget-dark:hover, .small-box:hover {
            transform: translateY(-3px);
            box-shadow: var(--gn-box-shadow); /* (20) */
        }
        .widget-title {
            font-weight: var(--gn-label-font-weight);
            margin-bottom: var(--gn-spacing-sm);
            font-size: var(--gn-widget-title-font-size); /* (21) */
            border-bottom: 1px solid var(--gn-border-color);
            padding-bottom: var(--gn-spacing-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
             color: var(--gn-light); /* Slightly brighter title */
        }
         .widget-body { flex-grow: 1; }
         .widget-dark h3 { /* For VPD, Uptime */
             font-weight: var(--gn-heading-font-weight);
             font-size: 2rem;
             margin-bottom: 0;
             text-align: left; /* Ensure left alignment */
             display: flex; align-items: center; /* Align icon + text (22) */
         }
         .widget-dark h3 i { font-size: 0.8em; margin-right: var(--gn-spacing-sm); opacity: 0.7; } /* (22) */

        /* Small Boxes Specifics */
        .small-box .inner { flex-grow: 1; text-align: left; /* (25) */ }
        .small-box .inner h3 { /* Temp, Humid, Count */
            font-size: 2.2rem; /* Larger value */
            font-weight: var(--gn-widget-value-font-weight);
            margin: 0 0 5px 0;
            white-space: nowrap;
            color: var(--gn-light);
            transition: color var(--gn-transition-fast); /* (17) */
        }
         .small-box .inner h3.widget-value-na { /* (23) */
             color: var(--gn-text-muted);
             font-style: italic;
             font-size: 1.8rem; /* Smaller for N/A */
         }
        .small-box .inner p { font-size: 0.9rem; margin-bottom: 0; color: var(--gn-text-muted); }
        .small-box .icon {
            position: absolute;
            top: 15px; right: 15px;
            font-size: 45px; /* Adjusted size */
            opacity: 0.1; /* More subtle */
            color: rgba(255,255,255,0.4);
            transition: opacity var(--gn-transition-std), transform var(--gn-transition-std);
            z-index: 0;
            display: flex; /* (19) */
            align-items: center; /* (19) */
            height: 100%; /* (19) */
            top: 0; /* (19) */
        }
         .small-box:hover .icon { opacity: 0.2; transform: scale(1.05) rotate(-5deg); }

         /* Conditional Icon Colors (Example - JS will add classes) */
         .temp-cold i { color: var(--gn-info) !important; }
         .temp-hot i { color: var(--gn-danger) !important; }
         .humid-low i, .humid-high i { color: var(--gn-warning) !important; } /* (17, 18) */

        /* Loading State for Widgets */
         .widget-loading .inner h3, .widget-loading .inner p, .widget-loading .widget-body h3 { /* (24) */
             color: transparent !important; /* Ensure text is hidden */
             background: linear-gradient(100deg, var(--gn-input-bg) 30%, var(--gn-input-border) 50%, var(--gn-input-bg) 70%) !important;
             background-size: 400% 100% !important;
             animation: loading-gradient 1.5s ease-in-out infinite !important;
             border-radius: var(--gn-border-radius-sm) !important;
             min-height: 1em; /* Ensure visibility */
             display: inline-block; /* Required for animation */
             opacity: 0.7;
         }
         .widget-loading .inner h3 { width: 70%; height: 2.2rem; margin-bottom: 5px;}
         .widget-loading .inner p { width: 90%; height: 0.9rem;}
         .widget-loading .widget-body h3 { width: 50%; height: 2rem; }
         .widget-loading .badge .loader { display: inline-block; } /* Show spinner in badge */
         .widget-loading .badge span:not(.loader) { display: none; } /* Hide text in badge */


         @keyframes loading-gradient {
           0% { background-position: 100% 50%; }
           100% { background-position: 0% 50%; }
         }

        /* --- Status Indicators --- */
        #systemStatusWidget .widget-body p { margin-bottom: var(--gn-spacing-sm); display: flex; align-items: center; justify-content: space-between; /* (32) */ }
        #systemStatusWidget .widget-body strong { margin-right: var(--gn-spacing-sm); color: var(--gn-text-muted); font-weight: var(--gn-label-font-weight);}
        #systemStatusWidget .widget-body span { text-align: right; }
        #pumpStatusIndicator { font-size: 0.9em; transition: background-color var(--gn-transition-fast), color var(--gn-transition-fast); display: inline-flex; align-items: center; gap: var(--gn-spacing-xs); }
        #stageModeIndicator { font-size: 0.9em; display: inline-flex; align-items: center; gap: var(--gn-spacing-xs);} /* (27) */
        #wifiStatusWrapper i { margin-right: var(--gn-spacing-xs); font-size: 0.9em; } /* Target icon inside wrapper */
        #lastMeasurementTime { font-size: 0.85em; color: var(--gn-text-muted); }
        #updatingIndicator i { animation: spin 1.5s linear infinite; } /* Make sync icon spin */

        /* Pulsing effect for pump indicator (31) */
         .pulsing {
             animation: pulse-border 1.8s infinite ease-out;
         }
         @keyframes pulse-border {
           0% { box-shadow: 0 0 0 0 rgba(var(--bs-success-rgb), 0.6); }
           70% { box-shadow: 0 0 0 8px rgba(var(--bs-success-rgb), 0); }
           100% { box-shadow: 0 0 0 0 rgba(var(--bs-success-rgb), 0); }
         }

        /* --- Chart & History --- */
        #measurementChartContainer {
             position: relative;
             height: 380px; /* Slightly taller */
             width: 100%;
             background: var(--gn-card-bg);
             padding: var(--gn-spacing-md);
             border-radius: var(--gn-border-radius);
             box-shadow: var(--gn-box-shadow-sm);
             border: 1px solid var(--gn-border-color);
             margin-bottom: var(--gn-spacing-md); /* Consistent spacing */
        }
         #measurementChartContainer .loading-indicator, #measurementChartContainer .empty-indicator { /* (40, 41) */
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             color: var(--gn-text-muted); font-style: italic; display: flex; align-items: center; gap: var(--gn-spacing-sm);
         }
        #measurementChart { max-width: 100%; }

        #measurementHistoryContainer .widget-title { /* (50) */
             position: sticky; top: 0; background-color: var(--gn-card-bg); z-index: 1;
             margin-bottom: 0; /* Remove margin as it's sticky */
             padding-bottom: var(--gn-spacing-sm);
             border-bottom: 1px solid var(--gn-border-color); /* Add border under sticky title */
        }
        #measurementHistory {
            background-color: #262a2e; /* Slightly different dark shade */
            border: 1px solid var(--gn-border-color);
            height: 380px; /* Match chart height */
            overflow-y: auto;
            font-size: 0.85rem;
            border-radius: var(--gn-border-radius);
            color: #ced4da;
            position: relative; /* For fade effect (51) */
        }
        /* Fade effect at top */
        #measurementHistory::before { /* (51) */
             content: ''; position: sticky; top: 0; display: block; width: 100%; height: 15px;
             background: linear-gradient(to bottom, #262a2e, transparent); /* Match history background */
             pointer-events: none; z-index: 2; margin-bottom: -15px; /* Overlap content slightly */
        }

        .measurement-history-entry {
            padding: var(--gn-spacing-xs) var(--gn-spacing-sm);
            border-bottom: 1px solid var(--gn-border-color); /* (48) */
            display: flex;
            flex-wrap: wrap;
            gap: 4px 12px;
            align-items: center;
            transition: background-color var(--gn-transition-fast); /* (44) */
        }
        .measurement-history-entry:last-child { border-bottom: none; }
        .measurement-history-entry:hover { background-color: rgba(255,255,255,0.05); /* (44) */ }
        .measurement-history-entry.new-entry-flash { /* (52) */
             animation: flash-bg-subtle 0.8s ease-out;
        }
        .measurement-history-entry .timestamp { font-weight: 500; color: var(--gn-text-muted); min-width: 90px; flex-shrink: 0; /* (45) */ }
        .measurement-history-entry .data-point { white-space: nowrap; }
        .measurement-history-entry .data-point i {
             margin-right: 5px; opacity: 0.8; width: 1.1em; text-align: center; /* Ensure alignment */
             /* (46) Icon Colors */
             &.fa-thermometer-half { color: var(--gn-chart-temp); }
             &.fa-tint { color: var(--gn-chart-humid); }
             &.fa-play, &.fa-play-circle { color: var(--gn-chart-pump); } /* Pump */
             &.fa-seedling { color: var(--gn-success); } /* Stage */
        }
        .measurement-history-entry .loading-indicator, .measurement-history-entry .empty-indicator { /* (49) */
             width: 100%; text-align: center; font-style: italic; padding: var(--gn-spacing-md) 0; color: var(--gn-text-muted);
             display: flex; align-items: center; justify-content: center; gap: var(--gn-spacing-sm);
        }
        .measurement-history-entry .error-indicator {
             width: 100%; text-align: center; font-style: italic; padding: var(--gn-spacing-md) 0; color: var(--gn-warning);
             display: flex; align-items: center; justify-content: center; gap: var(--gn-spacing-sm);
        }
        /* Custom Scrollbars (7) */
         #measurementHistory {
              scrollbar-width: thin; /* Firefox */
              scrollbar-color: var(--gn-secondary) rgba(0,0,0,0.1); /* Firefox */
         }
         #measurementHistory::-webkit-scrollbar { width: 8px; }
         #measurementHistory::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
         #measurementHistory::-webkit-scrollbar-thumb { background-color: var(--gn-secondary); border-radius: 4px; border: 2px solid transparent; background-clip: content-box; }
         #measurementHistory::-webkit-scrollbar-thumb:hover { background-color: #888; }

        /* --- Statistics Section --- */
        #statisticsSection .widget-dark { /* Override potential height:100% */
             height: auto;
        }
        #statisticsSection .widget-title { font-size: 1.15rem; /* (59) */ }
        #statisticsSection table { margin-bottom: 0 !important; }
        #statisticsSection thead {
            position: sticky; /* Make header sticky */
            top: 0; /* Stick to the top of the container */
            background-color: var(--gn-card-bg); /* Ensure background covers scrolled content */
            z-index: 2; /* Above table body content */
        }
        #statisticsSection th { /* (53) */
             font-weight: var(--gn-label-font-weight);
             color: var(--gn-text-muted);
             white-space: nowrap;
             border-bottom: 2px solid var(--gn-border-color); /* Thicker header border */
             padding-bottom: var(--gn-spacing-sm); /* More padding */
             padding-top: var(--gn-spacing-sm); /* Match bottom padding */
             text-align: center; /* Center headers */
             vertical-align: middle;
        }
         #statisticsSection th:first-child { text-align: left; } /* Left align period/stage name */
         #statisticsSection td {
             vertical-align: middle;
             padding: var(--gn-spacing-sm); /* More padding */
             text-align: center; /* Center data */
             border-bottom: 1px solid var(--gn-border-color); /* Row lines */
         }
         #statisticsSection tr:last-child td { border-bottom: none; } /* Remove last border */
         #statisticsSection td:first-child { text-align: left; } /* Left align period/stage name */
         #statisticsSection tbody tr:nth-child(odd):not(.text-muted) { /* (54) - Zebra stripes */
             background-color: rgba(0,0,0,0.05);
         }
         #statisticsSection .text-muted td { font-size: 0.8em; padding: var(--gn-spacing-xs) var(--gn-spacing-sm); color: var(--gn-text-muted) !important; border-bottom: none; border-top: 1px dashed var(--gn-border-color); } /* Range row */
         #statisticsSection small { font-size: 0.8em; color: var(--gn-text-muted); display: block; line-height: 1.2;} /* Min-max range */
         #statisticsSection .stat-na { color: var(--gn-text-muted); font-style: italic; /* (55) */ }

         /* Responsive table handling (60) */
         .stats-table-container { overflow-x: auto; max-height: 400px; /* Add max height for scroll */ }
         #statisticsSection .loading-indicator, #statisticsSection .error-indicator { /* Styling for stats loading/error */
             text-align: center; font-style: italic; padding: var(--gn-spacing-lg); color: var(--gn-text-muted);
             display: flex; align-items: center; justify-content: center; gap: var(--gn-spacing-sm);
         }
         #statisticsSection .error-indicator { color: var(--gn-danger); font-weight: 500; }


        /* --- Forms & Controls --- */
        fieldset {
            border: 1px solid var(--gn-border-color);
            border-radius: var(--gn-border-radius); /* (65) */
            padding: var(--gn-spacing-lg); /* (65) */
            margin-bottom: var(--gn-spacing-md);
            background-color: var(--gn-card-bg); /* Match widget background */
            box-shadow: var(--gn-box-shadow-sm);
        }
        legend.widget-title {
            border-bottom: none; margin-bottom: var(--gn-spacing-md); padding: 0;
            width: auto; /* Allow legend to size naturally */ float: none; /* Reset bootstrap override */
             font-size: var(--gn-widget-title-font-size); /* Consistent title size */
             display: inline-flex; align-items: center; gap: var(--gn-spacing-sm); /* Icon + text */
        }
        .form-label { font-weight: var(--gn-label-font-weight); margin-bottom: var(--gn-spacing-xs) !important; }
        .form-control, .form-select {
            background-color: var(--gn-input-bg);
            border: 1px solid var(--gn-input-border);
            color: var(--gn-text);
            border-radius: var(--gn-border-radius-sm); /* Smaller radius for inputs */
             transition: border-color var(--gn-transition-fast), box-shadow var(--gn-transition-fast);
        }
        .form-control:focus, .form-select:focus {
            background-color: var(--gn-input-bg); /* Keep background same on focus */
            border-color: var(--gn-primary);
            box-shadow: 0 0 0 3px var(--gn-focus-ring-color); /* Consistent focus ring */
            color: var(--gn-text);
            outline: none;
        }
         .form-control::placeholder { color: var(--gn-text-muted); opacity: 0.7; /* (63) */ }
         .form-control.is-invalid, .form-select.is-invalid { border-color: var(--gn-danger) !important; /* Ensure override */ }
         .form-control.is-invalid:focus, .form-select.is-invalid:focus { box-shadow: 0 0 0 3px rgba(var(--bs-danger-rgb), .4); }
         .form-text { font-size: 0.85rem; color: var(--gn-text-muted); margin-top: var(--gn-spacing-xs); /* (66) */ }
         /* Select arrow styling (64) - Basic override */
         .form-select {
              background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23adb5bd' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
         }
         /* Ensure number input spinners are styled for dark mode */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: button; /* Use button appearance for better visibility */
            opacity: 0.5;
            filter: invert(1) brightness(0.8); /* Make arrows visible on dark input */
            cursor: pointer;
            margin: 0 2px 0 0; /* Add slight margin */
        }
        input[type=number] { -moz-appearance: textfield; } /* Firefox */


        /* --- Buttons --- */
        .btn {
            border-radius: var(--gn-border-radius);
            padding: var(--gn-spacing-sm) var(--gn-spacing-md);
            font-size: 0.9rem;
            font-weight: var(--gn-label-font-weight);
            transition: transform var(--gn-transition-fast), box-shadow var(--gn-transition-fast), background-color var(--gn-transition-fast), border-color var(--gn-transition-fast);
            box-shadow: var(--gn-box-shadow-sm);
             display: inline-flex; /* Align icon and text */
             align-items: center;
             justify-content: center;
             gap: var(--gn-spacing-sm); /* Space between icon and text */
             white-space: nowrap; /* Prevent wrapping */
        }
         .btn:hover { transform: translateY(-2px); box-shadow: var(--gn-box-shadow); }
         .btn:active { /* (67) */
             transform: translateY(0px);
             box-shadow: var(--gn-box-shadow-inset);
         }
         .btn:focus-visible { /* Handled by global focus */ }
         .btn.disabled, .btn:disabled { /* (68) */
             opacity: 0.5 !important; /* Ensure override */
             cursor: not-allowed !important;
             transform: none;
             box-shadow: none;
         }
         .btn i.fa, .btn i.fas { margin: 0; /* Removed margin, using gap now */ /* (62) */ }
         .btn .loader { /* (75) */
             margin-left: 0; /* Using gap */
             width: 16px;
             height: 16px;
             border-width: 2px;
         }
         .btn-sm { padding: var(--gn-spacing-xs) var(--gn-spacing-sm); font-size: 0.8rem; gap: var(--gn-spacing-xs); }
         .btn-lg { font-size: 1rem; padding: 0.65rem 1.25rem; }

         /* Action button grouping (61) */
         .action-button-group { display: grid; grid-template-columns: 1fr; gap: var(--gn-spacing-sm); }
         @media (min-width: 576px) { /* Side-by-side on larger screens */
            .action-button-group { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
         }


        /* --- Feedback & Loaders --- */
        /* Loader Spinner */
        .loader, .spinner-border { /* Style bootstrap spinner too */
            border-color: rgba(255,255,255,0.2); /* Lighter border */
            border-right-color: var(--gn-primary); /* Use right instead of top */
            border-radius: 50%;
            animation: spin 0.8s linear infinite; /* Faster spin */
            display: inline-block;
            vertical-align: middle;
        }
        .loader { border-width: 3px; width: 18px; height: 18px; }
        .loader-sm, .spinner-border-sm { border-width: 2px !important; width: 1em !important; height: 1em !important; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

         /* Global Loader (74) */
         #globalLoader {
             position: fixed; top: 0; left: 0; width: 100%; height: 3px;
             background-color: var(--gn-primary); z-index: 10000; display: none;
             animation: pulse-loader 1.5s infinite alternate ease-in-out;
             box-shadow: 0 0 10px var(--gn-primary);
         }
         @keyframes pulse-loader {
              0% { width: 0%; opacity: 0.6; }
              50% { width: 100%; opacity: 1; }
              100% { width: 0%; opacity: 0.6; }
         }

        /* Toast Notifications (71, 72) */
        #toastContainer {
            position: fixed; top: calc(var(--gn-spacing-md) + 58px); /* Below navbar */
            right: var(--gn-spacing-md); z-index: 1055; width: 340px;
        }
         .toast {
             border-radius: var(--gn-border-radius);
             box-shadow: 0 5px 15px rgba(0,0,0,0.4);
             opacity: 0;
             transition: opacity var(--gn-transition-std), transform var(--gn-transition-std);
             transform: translateX(20px); /* Slide in from right */
             border: none; /* Remove default border */
             background-clip: padding-box; /* Fix potential border issues */
         }
         .toast.show { opacity: 1; transform: translateX(0); }
         .toast .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
         .toast-header { background-color: rgba(0,0,0,0.3); color: var(--gn-light); border-bottom: 1px solid rgba(255,255,255,0.1); }
         .toast-body { font-size: 0.9rem; display: flex; align-items: center; gap: var(--gn-spacing-sm); }
         .toast-body i { font-size: 1.2em; /* (71) */ flex-shrink: 0; }


        /* Subtle update flash (76) */
         .updated {
             animation: flash-bg-subtle 0.7s ease-out;
         }
         @keyframes flash-bg-subtle {
             0% { background-color: rgba(var(--bs-primary-rgb), 0.15); }
             100% { background-color: transparent; }
         }
         @keyframes flash-bg { /* Keep original for history if needed */
             0% { background-color: rgba(var(--bs-primary-rgb), 0.2); }
             100% { background-color: transparent; }
         }
         
         @keyframes pulse {
             0%, 100% { opacity: 1; transform: scale(1); }
             50% { opacity: 0.7; transform: scale(1.05); }
         }

         /* Tooltip styling */
         .tooltip { --bs-tooltip-bg: var(--gn-chart-tooltip-bg); --bs-tooltip-color: var(--gn-light); --bs-tooltip-opacity: 1; --bs-tooltip-border-radius: var(--gn-border-radius-sm); --bs-tooltip-padding-y: var(--gn-spacing-xs); --bs-tooltip-padding-x: var(--gn-spacing-sm); --bs-tooltip-font-size: 0.8rem; max-width: 280px; box-shadow: var(--gn-box-shadow-sm); }
         .tooltip .tooltip-arrow::before { background-color: var(--gn-chart-tooltip-bg); }

        /* System Restarting Overlay (78) */
         body.system-restarting::before {
             content: "System Restarting... Please Wait";
             position: fixed; top: 0; left: 0; width: 100%; height: 100%;
             background-color: rgba(0, 0, 0, 0.8); /* Darker overlay */
             color: white; display: flex; justify-content: center; align-items: center;
             font-size: 1.5rem; font-weight: 500; z-index: 10001;
             backdrop-filter: blur(4px);
             cursor: wait; /* Indicate waiting */
             text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
         }
         /* Optional: Add spinner to restart overlay */
         body.system-restarting::after {
             content: '';
             position: fixed; top: calc(50% + 40px); left: 50%;
             transform: translateX(-50%);
             width: 30px; height: 30px;
             border: 4px solid rgba(255, 255, 255, 0.3);
             border-top-color: white;
             border-radius: 50%;
             animation: spin 1s linear infinite;
             z-index: 10002;
         }

        /* --- Utilities --- */
        .text-muted { color: var(--gn-text-muted) !important; }
        .text-success { color: var(--gn-success) !important; }
        .text-info { color: var(--gn-info) !important; }
        .text-warning { color: var(--gn-warning) !important; }
        .text-danger { color: var(--gn-danger) !important; }
        .text-primary { color: var(--gn-primary) !important; }
        .text-light { color: var(--gn-light) !important; }
        .text-white { color: #fff !important; }

        .bg-success-light { background-color: rgba(var(--bs-success-rgb), 0.1) !important; }
        .bg-warning-light { background-color: rgba(var(--bs-warning-rgb), 0.1) !important; }
        .bg-info-light { background-color: rgba(var(--bs-info-rgb), 0.1) !important; }

        .cursor-help { cursor: help; } /* For info icons */
        .cursor-pointer { cursor: pointer; }

        /* Ensure loaders inside badges are visible */
         .badge .loader, .badge .spinner-border { border-right-color: currentColor !important; border-color: rgba(255,255,255,0.3) !important;}
         .badge.text-dark .loader, .badge.text-dark .spinner-border { border-right-color: currentColor !important; border-color: rgba(0,0,0,0.3) !important; }

         /* Align stage config table */
         #stageConfigTableContainer .table th, #stageConfigTableContainer .table td {
             padding-top: var(--gn-spacing-xs);
             padding-bottom: var(--gn-spacing-xs);
             vertical-align: middle; /* Ensure vertical alignment */
         }
         #stageConfigTableContainer .table th:first-child, #stageConfigTableContainer .table td:first-child {
             text-align: left;
             padding-left: var(--gn-spacing-sm); /* Add padding for first column */
         }
          #stageConfigTableContainer .table td:last-child {
              padding-right: var(--gn-spacing-sm); /* Add padding for actions column */
          }
         #stageConfigTableContainer .table th {
             font-weight: var(--gn-label-font-weight);
             color: var(--gn-text-muted);
         }


    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed dark-mode">
    <div id="globalLoader"></div>
    <!-- ARIA Live Region for Screen Readers (85) -->
    <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>
    <!-- Accessible status updates -->
    <div id="sr-status-messages" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="visually-hidden-focusable">Skip to main content</a>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" width="30" height="30" aria-hidden="true" focusable="false">
                  <style>.leaf{fill:#2ecc71}.stem{stroke:#27ae60;stroke-width:4;stroke-linecap:round}</style>
                  <path class="leaf" d="M50 10 C20 40 30 70 50 90 C70 70 80 40 50 10z"/>
                  <path class="leaf" d="M30 30 C10 50 20 80 30 90 C50 80 50 50 30 30z"/>
                  <path class="leaf" d="M70 30 C90 50 80 80 70 90 C50 80 50 50 70 30z"/>
                  <line class="stem" x1="50" y1="90" x2="50" y2="100"/>
                </svg>
                <span>Green Nanny</span>
            </a>
             <!-- Device IP/Name Placeholder (14) -->
            <span class="navbar-text d-none d-lg-inline ms-2" id="navbarDeviceName"></span>
            <!-- Test Mode Indicator -->
            <span class="badge bg-warning text-dark ms-2 d-none" id="testModeIndicator" style="animation: pulse 2s infinite;">
                <i class="fas fa-flask"></i> TEST MODE ACTIVE
            </span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item me-2"><a class="nav-link active" href="index.html" aria-current="page">Dashboard</a></li>
                    <li class="nav-item ms-2"><button class="btn btn-sm btn-outline-light" id="btnDev1" type="button" title="Ir a greennanny.local">Nanny 1</button></li>
                    <li class="nav-item ms-2"><button class="btn btn-sm btn-outline-light" id="btnDev2" type="button" title="Ir a greennanny2.local">Nanny 2</button></li>
                    <li class="nav-item ms-2"><button class="btn btn-sm btn-outline-light" id="btnDev3" type="button" title="Ir a greennanny3.local">Nanny 3</button></li>
                </ul>
            </div>
        </div>
    </nav>

    

    <div class="wrapper">
        <!-- Use main element (90) -->
        <main class="content-wrapper" id="main-content">
            <!-- Use section element (90) -->
            <section class="content-header" aria-labelledby="dashboard-title">
                <div class="container-fluid">
                    <div class="row mb-4 mt-2">
                        <div class="col-12"><h1 id="dashboard-title">Green Nanny Dashboard</h1></div>
                    </div>
                </div>
            </section>
            <section class="content" aria-label="Sensor Data and Status">
                <div class="container-fluid">
                    <!-- Row 1: Key Sensor Data & Stage -->
                     <div class="row gy-4">
                        <div class="col-lg-3 col-md-6">

                            <div class="small-box widget-loading" id="tempWidget">
                                <div class="inner">
                                    <h3 id="temperature">- °C</h3>
                                    <p>Ambient Temperature</p>
                                </div>
                                <div class="icon"><i class="fas fa-thermometer-half" aria-hidden="true"></i></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="small-box widget-loading" id="humidWidget">
                                <div class="inner">
                                    <h3 id="humidity">- %</h3>
                                    <p>Ambient Humidity</p>
                                </div>
                                 <div class="icon"><i class="fas fa-tint" aria-hidden="true"></i></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="small-box widget-loading" id="stageWidget">
                                <div class="inner">
                                    <h3 id="currentStageLabel" class="fs-5 mb-1">-</h3>
                                    <p>Current Plant Stage</p>
                                    <small id="currentStageParams" class="d-block text-muted"></small>
                                </div>
                                <div class="icon"><i class="fas fa-seedling" aria-hidden="true"></i></div>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="small-box widget-loading" id="pumpCountWidget">
                                <div class="inner">
                                    <h3 id="pumpActivationCount">-</h3>
                                    <p>Total Pump Cycles</p>
                                </div>
                                <div class="icon"><i class="fas fa-history" aria-hidden="true"></i></div>
                            </div>
                        </div>
                    </div>


                    <!-- Row 2: Derived Data & Status -->
                     <div class="row gy-4">
                        <div class="col-lg-4 col-md-6">
                            <div class="widget-dark widget-loading" id="vpdWidget">
                                <div class="widget-title">
                                     <span><i class="fas fa-wind me-2 opacity-75" aria-hidden="true"></i>VPD</span>
                                     <i class="fas fa-info-circle text-muted ms-1 cursor-help" data-bs-toggle="tooltip" data-bs-placement="top" title="Vapor Pressure Deficit (kPa): Indicates plant transpiration potential. Ideal range varies by stage." aria-label="VPD Information"></i>
                                </div>
                                <div class="widget-body"><h3 id="vpd">- kPa</h3></div>
                            </div>
                        </div>
                         <div class="col-lg-4 col-md-6">
                            <div class="widget-dark widget-loading" id="uptimeWidget">
                                <div class="widget-title"><i class="fas fa-stopwatch me-2 opacity-75" aria-hidden="true"></i>System Uptime</div>
                                <div class="widget-body"><h3 id="totalElapsedTime">-</h3></div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-12">
                             <div class="widget-dark widget-loading" id="systemStatusWidget">
                                 <div class="widget-title">System Status</div>
                                 <div class="widget-body">
                                     <p><strong>Pump:</strong> <span id="pumpStatusIndicator" class="badge bg-secondary"><span class="loader loader-sm" role="status"></span></span></p>
                                     <p><strong>Mode:</strong> <span id="stageModeIndicator" class="badge bg-secondary"><span class="loader loader-sm" role="status"></span></span></p>
                                     <!-- Structure for WiFi Status and Tooltip -->
                                     <p><strong>WiFi:</strong>
                                         <span id="wifiStatusWrapper" class="text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Checking WiFi...">
                                             <span id="wifiStatusContent"><i class="fas fa-wifi text-secondary" aria-hidden="true"></i> <span class="loader loader-sm" role="status"></span> Checking...</span>
                                         </span>
                                     </p>
                                     <!-- End Structure -->
                                     <p class="mb-0"><strong>Last Reading:</strong> <small id="lastMeasurementTime" class="text-muted">-</small> <span id="updatingIndicator" class="text-primary small ms-1" style="display: none;"><i class="fas fa-sync"></i> Updating...</span></p>
                                 </div>
                             </div>
                         </div>
                    </div>


                    <hr/>

                    <!-- Row 3: Chart & History -->
                    <section class="row gy-4" aria-label="Measurement History">
                        <div class="col-lg-7">
                             <h2 class="h4 mb-2" id="chart-title">Sensor Reading History</h2>
                             <div id="measurementChartContainer">
                                <div class="loading-indicator"><span class="spinner-border spinner-border-sm" role="status"></span> Loading Chart...</div>
                                <div class="empty-indicator" style="display: none;">No history data for chart.</div>
                                <canvas id="measurementChart" role="img" aria-labelledby="chart-title"></canvas>
                             </div>
                        </div>
                        <div class="col-lg-5 d-flex flex-column">
                             <div class="widget-dark d-flex flex-column flex-grow-1" id="measurementHistoryContainer">
                                <div class="widget-title">Measurement Log (Recent)</div>
                                <div class="widget-body flex-grow-1" style="overflow: hidden;">
                                    <div id="measurementHistory" role="log" aria-live="polite">
                                         <div class='measurement-history-entry loading-indicator'><span class="spinner-border spinner-border-sm" role="status"></span> Loading history...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <hr/>

                     <!-- Row 4: Statistics -->
                    <section class="row" aria-label="Cultivation Statistics">
                        <div class="col-12">
                            <h2 class="h4 mb-3" id="stats-title">Cultivation Statistics</h2>
                            <div id="statisticsSection" class="mb-4" aria-live="polite" aria-labelledby="stats-title">
                                <div class="widget-dark p-3 loading-indicator">
                                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Loading Statistics...
                                </div>
                            </div>
                         </div>
                    </section>

                    <hr/>

                    <!-- Row 5: Controls & Settings -->
                    <section class="row" aria-label="Controls and Settings">
                         <div class="col-12"><h2 class="h4 mb-3">Controls & Settings</h2></div>
                        <div class="col-lg-6 d-flex flex-column gap-3">
                             <fieldset class="widget-dark mb-0">
                                 <legend class="widget-title">
                                      <i class="fas fa-seedling me-2 opacity-75" aria-hidden="true"></i>Plant Stage Control
                                      <span id="manualControlIndicator" class="badge bg-warning text-dark ms-2" style="display: none;">Manual Mode</span>
                                 </legend>
                                <div class="widget-body">
                                    <form id="manualStageForm" class="row gx-2 gy-2 align-items-end mb-3">
                                        <div class="col-sm-8">
                                            <label for="manualStageSelect" class="form-label small mb-1">Set Stage Manually:</label>
                                            <select id="manualStageSelect" class="form-select form-select-sm" aria-label="Select plant stage for manual control">
                                                 <option value="" disabled selected>Loading stages...</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-4">
                                            <button type="submit" class="btn btn-secondary btn-sm w-100"><i class="fas fa-user-cog" aria-hidden="true"></i>Set Manual</button>
                                        </div>
                                    </form>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <button class="btn btn-outline-danger btn-sm" id="resetManualStageButton" data-bs-toggle="tooltip" title="Return to automatic stage progression based on time.">
                                             <i class="fas fa-undo" aria-hidden="true"></i> Reset to Auto
                                         </button>
                                         <button class="btn btn-sm btn-outline-info" id="refreshStage" data-bs-toggle="tooltip" title="Refresh current stage info" aria-label="Refresh Stage Info">
                                                <i class="fas fa-sync" aria-hidden="true"></i> Refresh
                                         </button>
                                    </div>
                                </div>
                            </fieldset>

                            <fieldset class="widget-dark mb-0">
                                <legend class="widget-title"><i class="fas fa-clock me-2 opacity-75" aria-hidden="true"></i>Measurement Interval</legend>
                                <div class="widget-body">
                                    <form id="intervalForm" class="row gx-2 gy-2 align-items-end">
                                        <div class="col flex-grow-1">
                                            <label for="intervalInput" class="form-label small mb-1">Interval (Hours):</label>
                                            <div class="input-group input-group-sm">
                                                <input type="number" name="interval" id="intervalInput" class="form-control" placeholder="Enter hours (1-167)" min="1" max="167" required aria-describedby="intervalHelp" aria-label="Measurement interval in hours"/>
                                                 <span class="input-group-text">Hours</span>
                                            </div>
                                             <div id="intervalHelp" class="form-text">Current: <span id="currentInterval">-</span>h. Set how often measurements run.</div>
                                        </div>
                                        <div class="col-auto">
                                            <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-save" aria-hidden="true"></i>Set Interval</button>
                                        </div>
                                    </form>
                                </div>
                            </fieldset>
                        </div>

                        <div class="col-lg-6">
                            <fieldset class="widget-dark h-100">
                                <legend class="widget-title"><i class="fas fa-cogs me-2 opacity-75" aria-hidden="true"></i>System Actions</legend>
                                <div class="widget-body action-button-group">
                                    <button id="activatePump" class="btn btn-success"><i class="fas fa-play-circle" aria-hidden="true"></i> Activate Pump...</button>
                                    <button id="deactivatePump" class="btn btn-warning"><i class="fas fa-stop-circle" aria-hidden="true"></i> Deactivate Pump</button>
                                    <button id="takeMeasurement" class="btn btn-info"><i class="fas fa-ruler-combined" aria-hidden="true"></i> Trigger Measurement</button>
                                    <button id="clearMeasurements" class="btn btn-danger"><i class="fas fa-trash-alt" aria-hidden="true"></i> Clear History</button>
                                    <button id="toggleTestMode" class="btn btn-outline-warning"><i class="fas fa-flask" aria-hidden="true"></i> <span id="testModeButtonText">Enable Test Mode</span></button>
                                    <button id="restartSystem" class="btn btn-outline-danger mt-auto"><i class="fas fa-power-off" aria-hidden="true"></i> Restart System</button>
                                </div>
                            </fieldset>
                        </div>
                    </section>

                    <hr/>

                    <!-- Row 6: Fan & Extractor Control (NEW) -->
                    <section class="row" aria-label="Fan and Extractor Controls">
                         <div class="col-12"><h2 class="h4 mb-3">Fan & Extractor Control</h2></div>
                        <div class="col-lg-6 d-flex flex-column gap-3">
                             <fieldset class="widget-dark mb-0">
                                 <legend class="widget-title">
                                      <i class="fas fa-fan me-2 opacity-75" aria-hidden="true"></i>Manual Controls
                                 </legend>
                                <div class="widget-body">
                                    <div class="mb-3">
                                        <strong>Fan Status:</strong> <span id="fanStatusIndicator" class="badge bg-secondary ms-2"><span class="loader loader-sm" role="status"></span></span>
                                    </div>
                                    <div class="action-button-group mb-3">
                                        <button id="activateFan" class="btn btn-success btn-sm"><i class="fas fa-play-circle" aria-hidden="true"></i> Turn ON Fan</button>
                                        <button id="deactivateFan" class="btn btn-warning btn-sm"><i class="fas fa-stop-circle" aria-hidden="true"></i> Turn OFF Fan</button>
                                    </div>
                                    <hr class="my-3">
                                    <div class="mb-3">
                                        <strong>Extractor Status:</strong> <span id="extractorStatusIndicator" class="badge bg-secondary ms-2"><span class="loader loader-sm" role="status"></span></span>
                                    </div>
                                    <div class="action-button-group">
                                        <button id="activateExtractor" class="btn btn-success btn-sm"><i class="fas fa-play-circle" aria-hidden="true"></i> Turn ON Extractor</button>
                                        <button id="deactivateExtractor" class="btn btn-warning btn-sm"><i class="fas fa-stop-circle" aria-hidden="true"></i> Turn OFF Extractor</button>
                                    </div>
                                </div>
                            </fieldset>
                        </div>

                        <div class="col-lg-6">
                            <fieldset class="widget-dark h-100">
                                <legend class="widget-title"><i class="fas fa-sliders-h me-2 opacity-75" aria-hidden="true"></i>Automatic Thresholds</legend>
                                <div class="widget-body">
                                    <form id="thresholdsForm">
                                        <div class="row g-2 mb-2">
                                            <div class="col-12"><small class="text-muted"><i class="fas fa-fan me-1"></i>Fan Activation</small></div>
                                            <div class="col-6">
                                                <label for="fanTempThreshold" class="form-label small mb-1">Temp (°C):</label>
                                                <input type="number" id="fanTempThreshold" class="form-control form-control-sm" min="0" max="50" step="0.1" placeholder="28.0" required/>
                                            </div>
                                            <div class="col-6">
                                                <label for="fanHumThreshold" class="form-label small mb-1">Humidity (%):</label>
                                                <input type="number" id="fanHumThreshold" class="form-control form-control-sm" min="0" max="100" step="1" placeholder="70" required/>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-3">
                                            <div class="col-12"><small class="text-muted"><i class="fas fa-wind me-1"></i>Extractor Activation</small></div>
                                            <div class="col-6">
                                                <label for="extractorTempThreshold" class="form-label small mb-1">Temp (°C):</label>
                                                <input type="number" id="extractorTempThreshold" class="form-control form-control-sm" min="0" max="50" step="0.1" placeholder="32.0" required/>
                                            </div>
                                            <div class="col-6">
                                                <label for="extractorHumThreshold" class="form-label small mb-1">Humidity (%):</label>
                                                <input type="number" id="extractorHumThreshold" class="form-control form-control-sm" min="0" max="100" step="1" placeholder="85" required/>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary btn-sm w-100"><i class="fas fa-save me-1" aria-hidden="true"></i>Save Thresholds</button>
                                        <div class="form-text mt-2">Devices activate automatically when temp OR humidity exceeds threshold.</div>
                                    </form>
                                </div>
                            </fieldset>
                        </div>
                    </section>

                    <hr/>

                    <!-- Row 7: Discord Alerts Configuration (NEW) -->
                    <section class="row" aria-label="Discord Alert Settings">
                        <div class="col-12"><h2 class="h4 mb-3"><i class="fab fa-discord me-2"></i>Discord Alerts</h2></div>
                        <div class="col-lg-12">
                            <fieldset class="widget-dark">
                                <legend class="widget-title"><i class="fas fa-bell me-2 opacity-75" aria-hidden="true"></i>Webhook Configuration</legend>
                                <div class="widget-body">
                                    <form id="discordForm">
                                        <div class="mb-3">
                                            <label for="discordWebhookUrl" class="form-label">Discord Webhook URL:</label>
                                            <input type="url" id="discordWebhookUrl" class="form-control" placeholder="https://discord.com/api/webhooks/..." required/>
                                            <div class="form-text">Get this URL from your Discord server settings: Server Settings → Integrations → Webhooks</div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" id="discordEnabled">
                                                <label class="form-check-label" for="discordEnabled">
                                                    <strong>Enable Discord Alerts</strong>
                                                </label>
                                            </div>
                                        </div>

                                        <hr class="my-3">
                                        
                                        <h6 class="mb-3">Alert Conditions:</h6>
                                        
                                        <div class="row g-3">
                                            <!-- Temperature Alerts -->
                                            <div class="col-md-6">
                                                <div class="border p-3 rounded">
                                                    <h6><i class="fas fa-thermometer-half me-2 text-danger"></i>Temperature Alerts</h6>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="tempHighAlert">
                                                        <label class="form-check-label" for="tempHighAlert">High Temperature</label>
                                                    </div>
                                                    <div class="input-group input-group-sm mb-3">
                                                        <span class="input-group-text">Threshold:</span>
                                                        <input type="number" id="tempHighThreshold" class="form-control" min="0" max="50" step="0.1" value="35">
                                                        <span class="input-group-text">°C</span>
                                                    </div>
                                                    
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="tempLowAlert">
                                                        <label class="form-check-label" for="tempLowAlert">Low Temperature</label>
                                                    </div>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">Threshold:</span>
                                                        <input type="number" id="tempLowThreshold" class="form-control" min="0" max="50" step="0.1" value="15">
                                                        <span class="input-group-text">°C</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Humidity Alerts -->
                                            <div class="col-md-6">
                                                <div class="border p-3 rounded">
                                                    <h6><i class="fas fa-tint me-2 text-primary"></i>Humidity Alerts</h6>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="humHighAlert">
                                                        <label class="form-check-label" for="humHighAlert">High Humidity</label>
                                                    </div>
                                                    <div class="input-group input-group-sm mb-3">
                                                        <span class="input-group-text">Threshold:</span>
                                                        <input type="number" id="humHighThreshold" class="form-control" min="0" max="100" step="1" value="85">
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                    
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="humLowAlert">
                                                        <label class="form-check-label" for="humLowAlert">Low Humidity</label>
                                                    </div>
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">Threshold:</span>
                                                        <input type="number" id="humLowThreshold" class="form-control" min="0" max="100" step="1" value="30">
                                                        <span class="input-group-text">%</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Other Alerts -->
                                            <div class="col-12">
                                                <div class="border p-3 rounded">
                                                    <h6><i class="fas fa-exclamation-triangle me-2 text-warning"></i>System Alerts</h6>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="sensorFailAlert">
                                                        <label class="form-check-label" for="sensorFailAlert">Sensor Failure</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="deviceActivationAlert">
                                                        <label class="form-check-label" for="deviceActivationAlert">Device Activations (Pump, Fan, Extractor)</label>
                                                        <div class="form-text">⚠️ This can generate many notifications</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mt-3">
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2" aria-hidden="true"></i>Save Discord Configuration</button>
                                            <button type="button" id="testDiscordAlert" class="btn btn-outline-secondary"><i class="fas fa-paper-plane me-2" aria-hidden="true"></i>Send Test Alert</button>
                                        </div>
                                    </form>
                                </div>
                            </fieldset>
                        </div>
                    </section>

                    <hr/>

                    <!-- Row 8: Stage Configuration (was Row 6) -->
                    <section class="row" aria-labelledby="stage-config-title">
                        <div class="col-12">
                            <h2 class="h4 mb-3" id="stage-config-title">Stage Configuration</h2>
                            <fieldset class="widget-dark">
                                <legend class="widget-title">
                                    <i class="fas fa-sliders-h me-2 opacity-75" aria-hidden="true"></i>Edit Stage Parameters
                                </legend>
                                <div class="widget-body">
                                    <div id="stageConfigLoading" class="text-center p-3 text-muted">
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Loading stage configurations...
                                    </div>
                                    <div id="stageConfigError" class="alert alert-danger d-none" role="alert">
                                        Error loading stage configurations.
                                    </div>
                                    <div class="table-responsive d-none" id="stageConfigTableContainer">
                                        <table class="table table-sm table-borderless table-dark small mb-0 align-middle">
                                            <thead>
                                                <tr>
                                                    <th>Stage Name</th>
                                                    <th class="text-center">Duration (Days)</th>
                                                    <th class="text-center">Humidity Threshold (%)</th>
                                                    <th class="text-center">Watering Time (s)</th>
                                                    <th class="text-center">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="stageConfigTableBody">
                                                <!-- Stage rows will be populated by JS -->
                                            </tbody>
                                        </table>
                                        <div class="form-text mt-2">Changes are saved per stage when you click its 'Save' button.</div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </section>

                </div><!-- /.container-fluid -->
            </section>
            <!-- /.content -->
        </main>
        <!-- /.content-wrapper -->

         <!-- Use footer element (90) -->
         <footer class="main-footer bg-dark text-center text-muted py-3 mt-auto">
             <small>Green Nanny v1.1 | Device: <span id="deviceIP">-</span> | <a href="#" onclick="event.preventDefault(); location.reload(true);" class="link-secondary text-decoration-underline">Force Refresh Page</a></small>
         </footer>

    </div>
    <!-- ./wrapper -->

    <!-- REQUIRED SCRIPTS -->
    <!-- jQuery (Keep for AdminLTE/Bootstrap plugins if needed) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <!-- Bootstrap 5 Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <!-- AdminLTE App (Minimal usage now) -->
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.1/dist/js/adminlte.min.js"></script>
    <!-- Chart.js 3.x -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js" integrity="sha256-ErZ09KkZnzjpqcane4SCyyHsKAXMvID9/xwbl/Aq1pc=" crossorigin="anonymous"></script>
    <!-- Moment.js (Optional - needed for better relative time if desired) -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js" integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KFKzEIHqvjlsXCmrGrA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->

    <!-- Main App Logic -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
